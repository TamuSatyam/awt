name: Build and Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build-linux-static:
    runs-on: ubuntu-latest
    container:
      image: alpine:latest
    steps:
      - name: Install dependencies
        run: |
          apk add --no-cache git cmake ninja g++ pkgconfig linux-headers \
            curl bash build-base \
            openssl-libs-static openssl-dev zlib-static zlib-dev \
            libssh2-static libssh2-dev

      - name: Checkout
        uses: actions/checkout@v4

      - name: Download dependencies
        run: |
          mkdir -p external/CLI11/include/CLI

          echo "Downloading simdjson..."
          curl -sL -o external/simdjson.h https://github.com/simdjson/simdjson/releases/download/v3.11.6/simdjson.h
          curl -sL -o external/simdjson.cpp https://github.com/simdjson/simdjson/releases/download/v3.11.6/simdjson.cpp

          echo "Downloading CLI11..."
          curl -sL https://github.com/CLIUtils/CLI11/archive/refs/tags/v2.4.2.tar.gz | tar xz -C external
          mv external/CLI11-2.4.2/include/CLI/* external/CLI11/include/CLI/
          rm -rf external/CLI11-2.4.2

          echo "Downloading cpp-httplib..."
          curl -sL -o external/httplib.h https://raw.githubusercontent.com/yhirose/cpp-httplib/v0.18.3/httplib.h

      - name: Build
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DOPENSSL_USE_STATIC_LIBS=TRUE \
            -DCMAKE_EXE_LINKER_FLAGS="-static" \
            -DBUILD_SHARED_LIBS=OFF
          cmake --build build --parallel $(nproc)
          strip build/ascii-weather-tui

      - name: Verify static binary
        run: |
          echo "File info:"
          file build/ascii-weather-tui
          echo ""
          echo "Checking dynamic dependencies:"
          if ldd build/ascii-weather-tui 2>&1 | grep -q "not a dynamic executable"; then
            echo "SUCCESS: Binary is fully static!"
          elif ldd build/ascii-weather-tui 2>&1 | grep -q "statically linked"; then
            echo "SUCCESS: Binary is statically linked!"
          else
            echo "FAILED: Binary has dynamic dependencies:"
            ldd build/ascii-weather-tui || true
            exit 1
          fi

      - name: Package
        run: |
          mkdir -p release
          cp build/ascii-weather-tui release/
          cd release
          tar -czf ascii-weather-tui-linux-x64-static.tar.gz ascii-weather-tui

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64-static
          path: release/ascii-weather-tui-linux-x64-static.tar.gz

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: brew install cmake ninja openssl

      - name: Download dependencies
        run: |
          mkdir -p external/CLI11/include/CLI

          curl -L -o external/simdjson.h https://github.com/simdjson/simdjson/releases/download/v3.11.6/simdjson.h
          curl -sL https://github.com/CLIUtils/CLI11/archive/refs/tags/v2.4.2.tar.gz | tar xz -C external
          mv external/CLI11-2.4.2/include/CLI/* external/CLI11/include/CLI/
          rm -rf external/CLI11-2.4.2
          curl -L -o external/CLI/CLI.hpp https://raw.githubusercontent.com/CLIUtils/CLI11/v2.4.2/include/CLI/CLI.hpp
          curl -L -o external/httplib.h https://raw.githubusercontent.com/yhirose/cpp-httplib/v0.18.3/httplib.h

      - name: Build
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DOPENSSL_ROOT_DIR=$(brew --prefix openssl)
          cmake --build build --parallel $(sysctl -n hw.ncpu)
          strip build/ascii-weather-tui

      - name: Package
        run: |
          mkdir -p release
          cp build/ascii-weather-tui release/
          cd release
          tar -czf ascii-weather-tui-macos-$(uname -m).tar.gz ascii-weather-tui

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: macos
          path: release/ascii-weather-tui-macos-*.tar.gz

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install OpenSSL
        run: |
          choco install openssl -y
          refreshenv

      - name: Download dependencies
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path external/CLI11/include/CLI

          Write-Host "Downloading simdjson..."
          Invoke-WebRequest -Uri "https://github.com/simdjson/simdjson/releases/download/v3.11.6/simdjson.h" -OutFile "external/simdjson.h"
          Invoke-WebRequest -Uri "https://github.com/simdjson/simdjson/releases/download/v3.11.6/simdjson.cpp" -OutFile "external/simdjson.cpp"

          Write-Host "Downloading CLI11..."
          Invoke-WebRequest -Uri "https://github.com/CLIUtils/CLI11/archive/refs/tags/v2.4.2.tar.gz" -OutFile "cli11.tar.gz"
          tar -xzf cli11.tar.gz -C external
          Move-Item -Path external/CLI11-2.4.2/include/CLI/* -Destination external/CLI11/include/CLI/
          Remove-Item -Recurse -Force external/CLI11-2.4.2
          Remove-Item cli11.tar.gz

          Write-Host "Downloading cpp-httplib..."
          Invoke-WebRequest -Uri "https://raw.githubusercontent.com/yhirose/cpp-httplib/v0.18.3/httplib.h" -OutFile "external/httplib.h"

      - name: Build
        run: |
          cmake -S . -B build -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DOPENSSL_ROOT_DIR="C:/Program Files/OpenSSL"
          cmake --build build --config Release --parallel

      - name: Package
        run: |
          mkdir release
          copy build\Release\ascii-weather-tui.exe release\
          cd release
          Compress-Archive -Path ascii-weather-tui.exe -DestinationPath ascii-weather-tui-windows-x64.zip

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: release/ascii-weather-tui-windows-x64.zip

  release:
    needs: [build-linux-static, build-macos, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/linux-x64-static/ascii-weather-tui-linux-x64-static.tar.gz
            artifacts/macos/ascii-weather-tui-macos-*.tar.gz
            artifacts/windows-x64/ascii-weather-tui-windows-x64.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
