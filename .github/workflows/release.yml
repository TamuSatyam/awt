name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  release-linux:
    name: Linux Fully Static (MUSL)
    runs-on: ubuntu-latest
    container: alpine:latest
    steps:
      - name: Install Build Tools
        run: |
          apk add --no-cache \
            build-base \
            cmake \
            git \
            ninja \
            linux-headers \
            ncurses-static \
            curl-static \
            openssl-libs-static \
            zlib-static

      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure and Build
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_EXE_LINKER_FLAGS="-static -static-libgcc -static-libstdc++"
          cmake --build build --config Release

      - name: Upload
        uses: softprops/action-gh-release@v2
        with:
          files: build/ascii-weather-tui
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-windows:
    name: Windows Static
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure and Build
        run: |
          # MSVC uses /MT for static runtime linking
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_MSVC_RUNTIME_LIBRARY="MultiThreaded"
          cmake --build build --config Release

      - name: Upload
        uses: softprops/action-gh-release@v2
        with:
          files: build/Release/ascii-weather-tui.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
